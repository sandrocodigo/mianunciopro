<div class="flex items-center justify-between py-4">
  <div>
    <h1 class="titulo" [animate.enter]="'fade-down'">Anuncios</h1>
    <p class="subtitulo" [animate.enter]="'fade-right'">Gestión de Anuncios</p>
  </div>
  <div class="ml-auto">
    <button [routerLink]="'nuevo'" [animate.enter]="'grow-in'" mat-fab extended matTooltip="Adicionar" type="button">
      <mat-icon>add</mat-icon>
      Nuevo
    </button>
  </div>
</div>

<section class="rounded-3xl border border-slate-200 bg-white/90 p-6 shadow-sm">
  <header class="mb-4 flex items-center justify-between">
    <div>
      <h2 class="text-lg font-semibold text-slate-800">Tus anuncios publicados</h2>
      <p class="text-sm text-slate-500">
        Revisa y actualiza la descripción o ubicación de cada anuncio rápidamente.
      </p>
    </div>
    <mat-icon class="text-slate-400!">equalizer</mat-icon>
  </header>

  @let data = listaAnuncios.data;
  @if (data.length === 0) {
  <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-6 text-center text-sm text-slate-500">
    Aún no registraste anuncios o no pudimos encontrarlos. Crea uno nuevo para comenzar.
  </div>
  } @else {
  <div class="overflow-x-auto">

    <table mat-table [dataSource]="listaAnuncios" class="w-full min-w-[720px] mat-elevation-z2 rounded-2xl">
      <ng-container matColumnDef="imagen">
        <th mat-header-cell *matHeaderCellDef
          class="text-left text-sm font-semibold uppercase tracking-wide text-slate-500">
          Imagen
        </th>
        <td mat-cell *matCellDef="let anuncio" class="py-4">
          @let miniatura = anuncio.fotos && anuncio.fotos.length ? anuncio.fotos[0] : null;
          <div class="flex justify-center">
            @if (miniatura) {
              <img
                [src]="miniatura"
                alt="Miniatura de {{ anuncio.titulo || 'anuncio' }}"
                class="h-14 w-20 rounded-xl border border-slate-200 object-cover shadow-sm"
              />
            } @else {
              <div
                class="flex h-14 w-20 items-center justify-center rounded-xl border border-dashed border-slate-300 bg-slate-50 text-slate-400">
                <mat-icon class="text-base!">image_not_supported</mat-icon>
              </div>
            }
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="categoria">
        <th mat-header-cell *matHeaderCellDef
          class="text-left text-sm font-semibold uppercase tracking-wide text-slate-500">
          Categoría
        </th>
        <td mat-cell *matCellDef="let anuncio" class="text-sm font-medium text-slate-800">
          {{ anuncio.categoria }} <br>
          <span class="text-xs">{{ anuncio.categoria1 }}</span> <br>
          <span class="text-xs">{{ anuncio.categoria2 }}</span> <br>
          <span class="text-xs">{{ anuncio.categoria3 }}</span>
        </td>
      </ng-container>
      <ng-container matColumnDef="ubicacion">
        <th mat-header-cell *matHeaderCellDef
          class="text-left text-sm font-semibold uppercase tracking-wide text-slate-500">
          Ubicacion
        </th>
        <td mat-cell *matCellDef="let anuncio" class="text-sm font-medium text-slate-800">
          {{ anuncio.ubicacion?.departamento }} <br>
          {{ anuncio.ubicacion?.provincia }} <br>
          {{ anuncio.ubicacion?.ciudad }} <br>
          {{ anuncio.ubicacion?.zona }} <br>
        </td>
      </ng-container>

      <ng-container matColumnDef="descripcion">
        <th mat-header-cell *matHeaderCellDef
          class="text-left text-sm font-semibold uppercase tracking-wide text-slate-500">
          Detalle
        </th>
        <td mat-cell *matCellDef="let anuncio" class="text-sm text-slate-700">
          {{ anuncio.titulo }} <br>
          {{ anuncio.descripcion }}<br>

          @if (anuncio.attrs && anuncio.categoria==='VEHICULOS') {
          <span class=" text-xs text-slate-400">Marca: {{ anuncio.attrs.marca }}</span> <br>
          <span class=" text-xs text-slate-400">Modelos: {{ anuncio.attrs.modelo }}</span><br>
          <span class=" text-xs text-slate-400">Año: {{ anuncio.attrs.anio }}</span><br>
          <span class=" text-xs text-slate-400">Kilometraje: {{ anuncio.attrs.kilometraje }}</span><br>
          <span class=" text-xs text-slate-400">Transmision: {{ anuncio.attrs.transmision }}</span><br>
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="publicado">
        <th mat-header-cell *matHeaderCellDef
          class="text-left text-sm font-semibold uppercase tracking-wide text-slate-500">
          Publicado
        </th>
        <td mat-cell *matCellDef="let anuncio" class="text-sm text-slate-700">
          <span [class.bg-green-100]="anuncio.publicado" [class.bg-red-100]="!anuncio.publicado"
            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
            {{ anuncio.publicado?'PUBLICADO':'PENDIENTE' }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="opciones">
        <th mat-header-cell *matHeaderCellDef
          class="text-right text-sm font-semibold uppercase tracking-wide text-slate-500">
          Opciones
        </th>
        <td mat-cell *matCellDef="let anuncio" class="text-right">
          <div class="flex justify-end gap-2">
<!--             <button mat-icon-button color="primary" (click)="editarUbicacion(anuncio)" matTooltip="Actualizar ubicación">
              <mat-icon>location_on</mat-icon>
            </button>
            <button mat-icon-button color="accent" (click)="editarDescripcion(anuncio)" matTooltip="Actualizar descripción">
              <mat-icon>description</mat-icon>
            </button>

            <button mat-icon-button color="accent" (click)="editarImagenes(anuncio)" matTooltip="Actualizar imagenes">
              <mat-icon>photo</mat-icon>
            </button> -->

            <a matButton="elevated" [routerLink]="'detalle/'+ anuncio.id">Detalle</a>



            <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Opciones">
              <mat-icon>more_vert</mat-icon>
            </button>

            <!-- Menú de opciones -->
            <mat-menu #menu="matMenu">

      
              <button mat-menu-item (click)="editarUbicacion(anuncio)"
                class="bg-gray-200 p-2 rounded-full hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors duration-300">
                <mat-icon color="primary">location_on</mat-icon>
                <span>Editar Ubicacion</span>
              </button>

              <button mat-menu-item (click)="editarDescripcion(anuncio)"
                class="bg-gray-200 p-2 rounded-full hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors duration-300">
                <mat-icon color="primary">description</mat-icon>
                <span>Editar Descripcion</span>
              </button>

              <button mat-menu-item (click)="editarImagenes(anuncio)">
                <mat-icon color="tertiary">photo</mat-icon>
                <span>Editar Imagenes</span>
              </button>
              
              <button mat-menu-item (click)="cambiarPublicacion(anuncio)">
                <mat-icon color="warn">{{anuncio.publicado?'close':'done'}}</mat-icon>
                <span>{{anuncio.publicado?'Dejar de Publicar':'Publicar'}}</span>
              </button>

            </mat-menu>

          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-slate-100"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
  }
</section>
